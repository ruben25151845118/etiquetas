import json
import sys

def clean_notebook(filename):
    """
    Limpia los metadatos problemáticos de un notebook de Jupyter
    """
    try:
        # Leer el archivo
        with open(filename, 'r', encoding='utf-8') as f:
            notebook = json.load(f)
        
        # Limpiar metadatos globales
        if 'metadata' in notebook:
            # Remover widgets problemáticos
            if 'widgets' in notebook['metadata']:
                del notebook['metadata']['widgets']
            
            # Limpiar otros metadatos problemáticos
            problematic_keys = ['colab', 'accelerator']
            for key in problematic_keys:
                if key in notebook['metadata']:
                    del notebook['metadata'][key]
        
        # Limpiar metadatos de cada celda
        if 'cells' in notebook:
            for cell in notebook['cells']:
                if 'metadata' in cell:
                    # Remover metadatos problemáticos de la celda
                    problematic_cell_keys = ['colab', 'executionInfo', 'outputId']
                    for key in problematic_cell_keys:
                        if key in cell['metadata']:
                            del cell['metadata'][key]
                
                # Limpiar outputs problemáticos
                if 'outputs' in cell:
                    for output in cell['outputs']:
                        if 'metadata' in output:
                            del output['metadata']
        
        # Guardar el archivo limpio
        cleaned_filename = filename.replace('.ipynb', '_cleaned.ipynb')
        with open(cleaned_filename, 'w', encoding='utf-8') as f:
            json.dump(notebook, f, indent=2, ensure_ascii=False)
        
        print(f"✅ Notebook limpiado exitosamente: {cleaned_filename}")
        return True
        
    except Exception as e:
        print(f"❌ Error limpiando el notebook: {e}")
        return False

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Uso: python clean_notebook.py archivo.ipynb")
    else:
        clean_notebook(sys.argv[1])
